<select id="cameraSelect" style="display: none;"></select>
<button id="applyCamera" style="display: none;">カメラ変更を適用</button>
<div id="result">カメラを初期化中…</div>
<div id="reader"></div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const readerId = "reader";
    const html5QrCode = new Html5Qrcode(readerId);
    const resultEl = document.getElementById("result");
    const cameraSelect = document.getElementById("cameraSelect");
    const applyBtn = document.getElementById("applyCamera");

    let cameras = [];
    let selectedCameraId = null;
    let isFront = false;

    function isFrontCamera(label) {
      return /front|user|前面/i.test(label);
    }

    function applyMirrorTransform(isFront) {
      const video = document.querySelector(`#${readerId} video`);
      if (video) {
        video.style.transform = isFront ? "scaleX(-1)" : "scaleX(1)";
      }
    }

    async function startScanner(cameraId, isFrontFacing) {
      if (html5QrCode._isScanning) {
        await html5QrCode.stop();
      }

      resultEl.textContent = "スキャン開始中...";

      html5QrCode.start(
        { deviceId: { exact: cameraId } },
        { fps: 15, qrbox: 250, disableFlip: true },
        qrCodeMessage => {
          resultEl.textContent = "読み取り成功: " + qrCodeMessage;
          sendToGoogleForm(qrCodeMessage);
        },
        error => console.warn("読み取りエラー:", error)
      ).then(() => {
        resultEl.textContent = "スキャン中です...";
        setTimeout(() => applyMirrorTransform(isFrontFacing), 1000);
      }).catch(err => {
        resultEl.textContent = "スキャン開始に失敗しました。";
        console.error(err);
      });
    }

    function sendToGoogleForm(message) {
      const parts = message.trim().split(" ");
      if (parts.length < 5) {
        resultEl.textContent = "無効なQRコードです。";
        return;
      }
      const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLScwRhzgKKSzDui_xlaHbH5SXpZ_HNPnvKaydBzX2VHBkYCsgg/formResponse";
      const formData = new FormData();
      formData.append("entry.372108176", parts[0]);
      formData.append("entry.1926098411", parts[1]);
      formData.append("entry.1678391181", parts[2]);
      formData.append("entry.1988792708", parts[3]);
      formData.append("entry.1373993560", parts[4]);

      fetch(formUrl, { method: "POST", mode: "no-cors", body: formData })
        .then(() => {
          resultEl.textContent = "送信しました！";
          setTimeout(() => startScanner(selectedCameraId, isFront), 2000);
        });
    }

    try {
      cameras = await Html5Qrcode.getCameras();
      if (cameras.length === 0) {
        resultEl.textContent = "カメラが見つかりません。";
        return;
      }

      if (cameras.length > 1) {
        cameraSelect.style.display = "inline-block";
        applyBtn.style.display = "inline-block";

        cameras.forEach((cam, index) => {
          const option = document.createElement("option");
          option.value = cam.id;
          option.text = cam.label || `カメラ ${index + 1}`;
          cameraSelect.appendChild(option);
        });

        applyBtn.addEventListener("click", () => {
          const idx = cameraSelect.selectedIndex;
          selectedCameraId = cameras[idx].id;
          isFront = isFrontCamera(cameras[idx].label);
          startScanner(selectedCameraId, isFront);
        });
      }

      // 最初のカメラで起動
      selectedCameraId = cameras[0].id;
      isFront = isFrontCamera(cameras[0].label);
      startScanner(selectedCameraId, isFront);

    } catch (err) {
      console.error("カメラ取得失敗:", err);
      resultEl.textContent = "カメラの取得に失敗しました。HTTPSでアクセスしていますか？";
    }
  });
</script>
