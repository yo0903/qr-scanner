<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>QRコードスキャン</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 {
      margin-bottom: 20px;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: auto;
    }
    #result {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>QRコードスキャン</h1>
  <div id="reader"></div>
  <div id="result">スキャン結果がここに表示されます</div>

  <script>
    const resultEl = document.getElementById('result');
    const html5QrCode = new Html5Qrcode("reader");

    // 画面サイズに応じたQRスキャン枠サイズ
    const getQrBoxSize = () => {
      const minEdge = Math.min(window.innerWidth, window.innerHeight);
      return Math.floor(minEdge * 0.8); // 80% のサイズ
    };

    function startScanner() {
      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 15,                 // 高速化：フレームレート上げる
          qrbox: getQrBoxSize(),  // 動的にサイズを調整
          aspectRatio: 1.777      // 16:9 の画角に近づける
        },
        qrCodeMessage => {
          html5QrCode.stop();
          resultEl.textContent = "読み取り成功: " + qrCodeMessage;

          const codeParts = qrCodeMessage.trim().split(" ");
          if (codeParts.length !== 5) {
            resultEl.textContent = "QRコードの形式が正しくありません。";
            setTimeout(() => startScanner(), 1000); // 待機短縮
            return;
          }

          const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLScwRhzgKKSzDui_xlaHbH5SXpZ_HNPnvKaydBzX2VHBkYCsgg/formResponse";
          const formData = new FormData();
          formData.append("entry.372108176", codeParts[0]); // 科目コード
          formData.append("entry.1926098411", codeParts[1]); // レポート回数
          formData.append("entry.1678391181", codeParts[2]); // フラグ
          formData.append("entry.1988792708", codeParts[3]); // 学籍番号
          formData.append("entry.1373993560", codeParts[4]); // 固定値

          fetch(formUrl, {
            method: "POST",
            mode: "no-cors",
            body: formData
          }).then(() => {
            resultEl.textContent = "送信しました！再スキャンします...";
            setTimeout(() => startScanner(), 1000); // 待機時間短縮
          }).catch(error => {
            console.error("送信エラー:", error);
            resultEl.textContent = "送信エラー";
            setTimeout(() => startScanner(), 2000);
          });
        },
        errorMessage => {
          // エラーは特に処理しない（デバッグ用）
          console.warn(`読み取りエラー: ${errorMessage}`);
        }
      );
    }

    startScanner();
  </script>
</body>
</html>
